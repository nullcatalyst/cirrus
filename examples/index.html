<!DOCTYPE html>
<html>
  <head>
    <title>demo</title>
  </head>

  <body>
    <script>
      async function load_wasm(url, callback) {
        let memory;
        const wasm = await WebAssembly.instantiateStreaming(fetch(url), {
          console: {
            log: (msg_start, msg_end) => {
              const text = new TextDecoder("utf8").decode(
                memory.buffer.slice(msg_start, msg_end)
              );
              console.log(text);
            },
            error: (msg_start, msg_end) => {
              const text = new TextDecoder("utf8").decode(
                memory.buffer.slice(msg_start, msg_end)
              );
              console.error(text);
            },
          },
          math: Math,
          time: {
            now_perf: () => performance.now(),
            now_unix: () => Date.now(),
          },
          env: {
            throw: (msg_start, msg_end) => {
              const text = new TextDecoder("utf8").decode(
                memory.buffer.slice(msg_start, msg_end)
              );
              throw new Error(text);
            },
            callback: (action, msg_start, msg_end) => {
              if (callback) {
                callback(msg_start, msg_end);
              } else {
                const text = new TextDecoder("utf8").decode(
                  memory.buffer.slice(msg_start, msg_end)
                );
                console.log(text);
              }
            },
          },
        });
        memory = wasm.instance.exports.memory;
        return {
          do_with_copy: (uint8_array, callback) => {
            const len = uint8_array.length;
            const ptr = wasm.instance.exports.malloc(len);
            const buffer = new Uint8Array(memory.buffer, ptr, len);
            buffer.set(uint8_array);
            callback(ptr, ptr + len, buffer);
            wasm.instance.exports.malloc(ptr);
          },
          ...wasm.instance.exports,
        };
      }

      (async () => {
        const should_download_wasm = false; // Set to true to download the compiled WebAssembly binary

        const rain = await load_wasm("rain2llvm.wasm", (msg_start, msg_end) => {
          const data = new Uint8Array(
            rain.memory.buffer,
            msg_start,
            msg_end - msg_start
          );
          const text = new TextDecoder("utf8").decode(data);
          console.log("Compiled LLVM IR:");
          console.log(text);

          llvm.do_with_copy(data, (msg_start, msg_end, llvm_uint8_array) => {
            llvm.compile(msg_start, msg_end);
          });
        });

        const llvm = await load_wasm("llvm2wasm.wasm", (msg_start, msg_end) => {
          const data = new Uint8Array(
            llvm.memory.buffer,
            msg_start,
            msg_end - msg_start
          );
          console.log("Compiled WebAssembly binary:");
          console.log(data);

          if (should_download_wasm) {
            const a = document.createElement("a");
            a.href = URL.createObjectURL(
              new Blob([data], { type: "application/wasm" })
            );
            a.download = "output.wasm";
            a.click();
          }

          wat.do_with_copy(data, (msg_start, msg_end, wat_uint8_array) => {
            wat.decompile(msg_start, msg_end);
          });
        });

        const wat = await load_wasm("wasm2wat.wasm", (msg_start, msg_end) => {
          const data = new Uint8Array(
            wat.memory.buffer,
            msg_start,
            msg_end - msg_start
          );
          const text = new TextDecoder("utf8").decode(data);

          console.log("Decompiled WebAssembly text:");
          console.log(text);
        });

        rain.init();
        llvm.init();
        wat.init();

        function compile(src) {
          console.log("Compiling source code:");
          console.log(src);

          const encoder = new TextEncoder();
          const encoded = encoder.encode(src);
          const len = encoded.length;
          const ptr = rain.malloc(len);
          new Uint8Array(rain.memory.buffer, ptr, len).set(
            new Uint8Array(encoded)
          );
          rain.compile(ptr, ptr + len);
          rain.free(ptr);
        }

        compile(`
export fn double(n: i32) -> i32 {
    let n = n * 2
    return n
}
`);
      })();
    </script>
  </body>
</html>
